# Спецификация: захват и загрузка фото/видео с AI-анализом на NAS

## План доработки (медиа-захват, загрузка на NAS, AI-анализ)
- Аналитика и требования: уточнить UX-флоу (карточка, Quick Add, AI Review), ограничения по размерам/таймаутам, опции scope; зафиксировать API контракты (`item_id`, `location_id`, `analyze`, `source`, статусы).
- Backend: расширить `/media/upload` (метаданные, hash/size, thumbs, optional link to item/location, analyze flag); добавить `GET /media/{id}` с прогрессом; валидация mime/размеров; логика автопривязки по AI; обновить AI видео-параметры и логи; очистка tmp; документация.
- Mobile (UI/UX): в карточке — кнопки «Снять фото/Записать видео», прогресс загрузки/AI, показ bbox; Quick Add — быстрый capture без item с переходом в AI Review; ручное подтверждение/отклонение связей; отображение статусов.
- Mobile (техника): FileProvider + `TakePicture`/`CaptureVideo`; загрузка с новыми полями (`source`, `analyze`, `item_id` optional); очередь/ретраи, отмена; scoped storage разрешения; отображение локального превью → серверный URL.
- AI/автопривязка: правила сопоставления с карточками/локациями, создание черновиков «требует подтверждения», UX подтверждения связей.
- Тесты: backend unit/integration (`upload`, авто-анализ, валидация, прогресс); mobile UI/инструментальные (capture, загрузка, статусы, bbox, подтверждения); E2E: фото/видео → NAS → AI Review → привязка/подтверждение.
- Развёртывание/документация: обновить README/build_and_run, описать новые эндпоинты, параметры мобильной сборки, ограничения/лимиты, чек-лист проверок на NAS.

### Детализация шага 1. Аналитика и требования
- UX-флоу:
  - Карточка предмета: снять фото/видео → мгновенное превью → загрузка → показ прогресса → статус AI (pending/in_progress/done/failed) → просмотр bbox → подтверждение/отклонение привязки к карточке/локации.
  - Quick Add: быстрый capture без карточки → загрузка в выбранный scope → автоматическая попытка сопоставить с существующими карточками/локациями → показ предложений и подтверждения → переход в AI Review.
  - AI Review: список детекций с медиа, статусами и bbox → действия accept/reject/link/create-new → возможность открыть предмет/создать черновик.
- Ограничения/таймауты:
  - Фото: рекомендуемый объём 3–5 МБ; допустимые форматы JPG/PNG/HEIC; таймаут загрузки 15–30 с; превышение — ошибка с ретраем.
  - Видео: рекомендуемый объём ≤100 МБ; длина до 5 минут; формат MP4 (H.264/AAC); таймаут загрузки 60–120 с; обработка AI может занять до 2–3 минут (с прогрессом/статусами).
  - Ограничить mime whitelist (image/jpeg, image/png, image/heic, video/mp4) и размер (конфиг на бэкенде), отдавать понятные ошибки.
- Scope:
  - Значения `public`/`private` выбирает пользователь в настройках; сервер принимает присланное значение без автопереключения.
  - Путь на NAS формируется с учётом scope и workspace/user.
- API контракты (фиксируем поля):
  - `POST /api/v1/media/upload`: multipart `file`; form `workspace_id` (int), `owner_user_id` (int), `media_type` (`photo|video|document`), `scope` (`public|private`), `subdir` (строка), `item_id` (optional int), `location_id` (optional int), `analyze` (bool, default true), `source` (`camera|gallery|share|upload`), `client_created_at` (ISO).
  - Ответ upload: `id`, `path`, `mime_type`, `thumb_path?`, `analysis` {`detection_ids` или `detection_id`, `status`}.
  - `GET /api/v1/media/{id}`: возвращает метаданные (size_bytes, hash, mime, scope, paths) + текущий статус анализа (`pending|in_progress|done|failed`) и список bbox (если есть).
  - Статусы AI: pending → in_progress → done/failed; детектированные объекты имеют decision (pending/accepted/rejected).

## Цель
Дать пользователю возможность фотографировать и записывать видео прямо в Android‑клиенте, мгновенно загружать файлы на NAS через backend и автоматически запускать AI-анализ (YOLO/CLIP, выборка кадров для видео). Функция должна работать как для новых предметов, так и для уже созданных карточек.

## Кратко о текущем состоянии
- API уже принимает `POST /api/v1/media/upload` и запускает `analyze_media`/`analyze_video` (backend/app/api/routes/media.py, app/services/ai).
- Мобильное приложение умеет прикреплять фото/видео из галереи к предмету (ItemDetailsScreen), но нет захвата камеры/записи, нет отдельного UX для быстрой загрузки без карточки, нет статусов загрузки/анализа.
- Хранилище NAS настроено через `MEDIA_PUBLIC_PATH`/`MEDIA_PRIVATE_PATH`; структура поддиректорий задаётся параметром `subdir`.

## Пользовательские сценарии
- Захват фото из камеры и мгновенная загрузка к выбранному предмету (из карточки).
- Запись короткого видео (до N минут) с загрузкой к предмету.
- Быстрый захват (фото/видео) из зоны «Быстро добавить» даже без карточки: файл уходит в публичный/приватный workspace, попадает в AI Review; позже можно привязать к предмету.
- Выбор уже снятого файла из галереи/файлового менеджера (fallback).
- Просмотр прогресса загрузки и статуса AI (pending → done/failed), открытие результата в AI Review.

## Требования к backend
- API
  - Расширить `POST /api/v1/media/upload`:
    - Доп. поля: `item_id` (опционально линковать к предмету), `location_id` (подстановка в AI), `analyze` (bool, по умолчанию true), `source` (camera/gallery/share), `client_created_at`.
    - Заполнять в `Media`: `size_bytes`, `file_hash` (sha256), `mime_type` из запроса, `thumb_path` (для фото + первого кадра видео).
    - Ответ дополнить `analysis` (идентификатор(ы) ai_detections, статус).
  - Добавить `GET /api/v1/media/{id}` с детальной информацией и текущим состоянием анализа (для UI прогресса).
  - Добавить лимиты/валидацию: макс. размер файла (конфиг), список mime, проверка `media_type` против файла.
- Хранение (NAS)
  - Путь: `{public|private}_media/{workspace}/{user}/{item|inbox}/{YYYYMMDD}/<file>`.
  - Видео: сохранять исходник; извлекать постер в `/thumbs/…` (ffmpeg/opencv).
  - Очистка временных кадров `/tmp_frames` после анализа.
- AI
  - Видео: параметризовать `frame_stride`, `max_frames` из настроек; фиксировать прогресс (in_progress → done/failed) в `aidetection.raw`.
  - Логирование: запись в INFO `media_id`, `source`, размер, время анализа; ошибки писать в raw и `AIDetectionStatus.FAILED`.
- Безопасность
  - Проверять доступ пользователя к workspace/item (пока заглушка — оставить комментарий TODO, либо параметризовать owner_user_id из JWT, когда будет auth).
  - Санитизация `subdir` и имён файлов (убрать `..`, запрещённые символы).

## Требования к mobile (Android, Jetpack Compose)
- UI/UX
  - В карточке предмета: блок «Медиа» дополняется кнопками «Снять фото» и «Записать видео» (рядом с «Выбрать из галереи»), показ прогресса загрузки и статуса AI по каждому файлу.
  - В Quick Add/MediaLinkScreen: быстрый capture/upload без привязки к item → после аплоада показывать кнопку «Открыть в AI Review»/«Привязать к предмету».
  - Показывать превью сразу после захвата (локальный файл), затем заменять на URL с NAS после аплоада.
- Техническая реализация
  - Захват фото: `ActivityResultContracts.TakePicture()` с FileProvider, сохранение во временный cache, EXIF-ориентация.
  - Запись видео: `ActivityResultContracts.CaptureVideo()` или кастомный `MediaStore.ACTION_VIDEO_CAPTURE` с ограничением длительности/качества (1080p, до N минут), размер оценивать до отправки.
  - Загрузка: использовать существующий `ApiService.uploadMedia`; добавить параметры `item_id`, `analyze`, `source`. После ответа, если `item_id` указан — авто-вызов `linkMedia` опустить (линковка произойдёт сервером).
  - Статусы: после загрузки опрашивать `GET /api/v1/media/{id}` или `GET /api/v1/ai/detections?status=in_progress` до `done/failed`; показывать индикатор/ошибку.
  - Ошибки/ретраи: сохранять очередь «ожидает загрузки» (room/in-memory), ретрай при восстановлении сети; отмена загрузки должна чистить временный файл.
- Разрешения
  - CAMERA (обязательно), RECORD_AUDIO (если пишем звук), POST_NOTIFICATIONS (опционально для фоновой загрузки), READ_MEDIA_* для API 33+, MANAGE_EXTERNAL_STORAGE не нужен.
- Аналитика
  - События: `media_capture_start`, `media_upload_success/fail`, `ai_analysis_seen`, с полями `type`, `duration_ms`, `size`, `source`, `item_id`.

## Нефункциональные требования
- Производительность: загрузка фото ≤ 5 с при 4G для 3–5 МБ; видео — в фоне с индикатором, размер по умолчанию ≤ 100 МБ.
- Надёжность: повторная отправка при временных 5xx/timeout; graceful degrade если AI недоступен (файл сохраняется, статус FAILED, пользователь уведомлён).
- Совместимость: Android 8.1+, учесть scoped storage (MediaStore + FileProvider).

## Тестирование и приёмка
- Backend: unit на `_ensure_extension`, расчёт hash/size, запись thumb; интеграционные на `/media/upload` (photo/video), генерацию `aidetections`, ссылку `item_id`, валидацию размеров/mime.
- Mobile: UI-тест на показ кнопок и прогресса, инструментальные тесты capture (использовать тестовую камеру/uri), реплей ошибок сети.
- E2E: снять фото в карточке → файл появляется в NAS пути, в AI Review виден новый detection со статусом done; снять видео → анализ создаёт хотя бы один detection; быстрый capture без item → медиазапись доступна в «Последние» и в AI Review.

## Открытые вопросы
- Максимальная длительность/битрейт видео и желаемое разрешение по умолчанию?
- Нужны ли приватные загрузки по умолчанию или держим `scope` = public?
- Автоматически ли привязывать незакреплённые загрузки из Quick Add к «inbox» локации?
- Нужно ли отображать превью AI (bbox) прямо в карточке предмета?

## Уточнения (ответы заказчика)
- Видео/фото: пользователь может прикреплять или записывать любые параметры (битрейт, длительность, разрешение); при необходимости бэкенд/модель выполняют даунскейл/препроцесс на своей стороне для качества и скорости.
- scope: пользователь выбирает private/public в настройках; сервер принимает присланное значение без автоматического переключения.
- Quick Add без item: модель пытается сопоставить медиа с существующими карточками и/или локациями; если они найдены — автоматически привязывает, но пользователь должен иметь возможность подтвердить/отклонить связи.
- Превью AI: bbox отображать прямо в карточке предмета; модель может создавать черновик новой карточки со статусом «требует подтверждения», предлагая название и привязывая фото/видео для подтверждения пользователем.
- Подтверждение и статусы: пользователь должен подтверждать связи с карточками/местами; показывать статус загрузки фото/видео на сервер и статус AI-анализа (pending/in_progress/done/failed).
